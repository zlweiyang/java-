# 《深入理解JVM虚拟机》 #

# 1.Java虚拟机运行时数据区域 #

## - 程序计数器 ##

记录当前线程所执行的字节码行号，用于获取下一条执行的字节码，Java虚拟机的多线程是通过轮流切换和分配处理器时间来实现的，为了线程切换后能够恢复到正确的位置，每个线程都需要有一个独立的程序计数器，所以程序计数器是**线程私有**的。

线程执行Java方法，这个计数器记录的是正在执行的虚拟机字节码，如果执行Native方法，这计数器为空。**程序计数器是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError内存溢出错误的区域。**

## - Java虚拟机栈 ##

Java虚拟机栈也是线程私有，生命周期与线程相同，虚拟机栈描述的是Java方法执行的内存模型：每个方法在执行的时候都会同时创建一个栈帧用于存储局部变量表、操作栈、动态链接、方法出口等信息。每个方法被调用直至执行完成的过程，就对应于栈帧在虚拟机栈中从入栈到出栈的过程。

局部变量表存放在编译时可知的八种基本数据类(boolean,byte,short,int,char,long,float,double),对象引用和returnAddress类型。

long,double为64长度的数据占用2个局部变量空间，其余数据类型只占1个局部变量空间，局部变量内存空间在编译期间完成分配。

两种异常：当线程请求的栈深度大于虚拟机锁允许的深度，将抛出StackoverflowError异常，
当虚拟机动态扩展无法申请足够的内存时(大部分虚拟机可动态扩展，也允许固定长度的虚拟机栈)，将会抛出OutOfMemoryError异常。

## - 本地方法栈 ##

本地方法栈与虚拟机栈所发挥的作用非常相似去区别主要是虚拟机栈执行Java方法(字节码)，而本地方法则为虚拟机使用到的Native方法服务，本地方法会抛出StackOverflowError和OutOfMemoryError。

## -Java堆 ##
Java堆是Java虚拟机所管理的内存中最大的一块。Java堆是被所有**线程共享**的一块区域，在虚拟机启动时创建。此内存区域的唯一目的就是存放对象实例，几乎所有的对象实例都在这里分配内存。

Java对是垃圾收集器管理的主要区域，因此很多时候也被称为"GC堆"。由于现在收集器都采用分代收集算法，所以Java堆中还可以细分为：新生代和老年代；在细致一点的有Eden空间、FromSurvivor空间、ToSurvivor空间。

Java虚拟机规定，Java堆可以处于物理上不连续的内存空间，只要逻辑上是连续的即可，就像我们的磁盘空间一样。在现实中，既可以实现固定大小的，也可以是可扩展的，当前虚拟机是可扩展来实现的(通过**-Xmx和-Xms**控制)。如果在堆中没有内存完成实例分配，并且堆也无法再扩展时，将会抛出OutOfMemoryError异常。

## - 方法区 ##

方法区与Java堆一样，是各个线程共享的内存区域，它被用于已经被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。虽然Java虚拟机规范把方法区描述为堆的一个逻辑部分，但是它却有一个别名叫做Non-Heap(非堆)，主要是为了与Java堆区分开。

对于习惯在HotSpot虚拟机上开发和部署程序的开发者来说，很多人愿意将方法区成为**永久代**是实际上两者并不等价，仅因为HotSpot虚拟机的设计团队选择将GC分代收集到方法区，或者使用永久代来实现方法区。

除和Java堆一样不需要连续的内存和可以选择固定大小或者可扩展外，还可以选择不实现垃圾回收。相对而言，垃圾回收行为在这个区域是比较少出现的，但并不是数据进入方法区就永久存在啦，这个区域的内存回收目标主要是针对常量池的回收和对类型的卸载。Java虚拟机规范规定，当方法区无法满足内存分配需求时，将抛出OutOfMemoryError异常。

## - 运行时常量池 ##

运行时常量池是方法区的一部分。Class文件中除了有类的版本、字段、方法、接口等描述信息，还有一项信息是常量池，用于存放编译器生成的各种字面量和符号引用。

运行时常量池相对于Class文件常量池的另一个重要特征是具备动态性，Java语言并不要求常量一定只有编译器才能产生，也就是并非预置入Class文件中常量池内容才能进入方法区的常量池。这种特性被开发人员利用的比较多的是String类的intern()方法。

## -直接内存 ##

- -Xms设置堆的最小空间大小。
- -Xmx设置堆的最大空间大小。
- -XX:NewSize设置新生代最小空间大小。
- -XX：MaxNewSize设置新生代最大空间大小。
- -XX：PermSize设置永久代最小空间大小。
- -XX：MaxPermSize设置永久代最大空间大小。
- -Xss设置每个线程的堆栈大小。

内容来源：`https://mp.weixin.qq.com/s?__biz=MzI4NDY5Mjc1Mg==&mid=2247483949&idx=1&sn=8b69d833bbc805e63d5b2fa7c73655f5&chksm=ebf6da52dc815344add64af6fb78fee439c8c27b539b3c0e87d8f6861c8422144d516ae0a837&scene=21#wechat_redirect`

《深入理解Java虚拟机》